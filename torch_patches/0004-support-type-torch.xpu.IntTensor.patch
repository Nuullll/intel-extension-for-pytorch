From cecd8b6b34ddc12b26df29313c4443d83fbfe48b Mon Sep 17 00:00:00 2001
From: "Yu, Guangye" <guangye.yu@intel.com>
Date: Mon, 22 May 2023 09:57:16 +0000
Subject: [PATCH 04/25] support type(torch.xpu.IntTensor)

---
 tools/autograd/templates/VariableType.h    |  1 +
 torch/csrc/autograd/VariableTypeManual.cpp |  4 ++++
 torch/csrc/utils/tensor_types.cpp          | 13 +++++++++++++
 3 files changed, 18 insertions(+)

diff --git a/tools/autograd/templates/VariableType.h b/tools/autograd/templates/VariableType.h
index ad2abc2bdb7..abad2f93384 100644
--- a/tools/autograd/templates/VariableType.h
+++ b/tools/autograd/templates/VariableType.h
@@ -46,6 +46,7 @@ using c10::optional;
 
 namespace VariableType {
   TORCH_API std::vector<at::DeprecatedTypeProperties*> allCUDATypes();
+  TORCH_API std::vector<at::DeprecatedTypeProperties*> allXPUTypes();
   TORCH_API std::vector<at::DeprecatedTypeProperties*> allCPUTypes();
 
   at::Tensor & unpack(Tensor & t, const char * name, int pos);
diff --git a/torch/csrc/autograd/VariableTypeManual.cpp b/torch/csrc/autograd/VariableTypeManual.cpp
index 2998e65d975..705c6b0c9df 100644
--- a/torch/csrc/autograd/VariableTypeManual.cpp
+++ b/torch/csrc/autograd/VariableTypeManual.cpp
@@ -46,6 +46,10 @@ C10_EXPORT std::vector<at::DeprecatedTypeProperties*> allCUDATypes() {
   return allTypesForBackends({Backend::CUDA, Backend::SparseCUDA});
 }
 
+C10_EXPORT std::vector<at::DeprecatedTypeProperties*> allXPUTypes() {
+  return allTypesForBackends({Backend::XPU, Backend::SparseXPU});
+}
+
 namespace {
 const Variable& checked_cast_variable(
     const Tensor& t,
diff --git a/torch/csrc/utils/tensor_types.cpp b/torch/csrc/utils/tensor_types.cpp
index d4e4dd1d38c..3df3e0b7ecc 100644
--- a/torch/csrc/utils/tensor_types.cpp
+++ b/torch/csrc/utils/tensor_types.cpp
@@ -70,9 +70,12 @@ std::string type_to_string(const at::DeprecatedTypeProperties& type) {
 
 at::TensorOptions options_from_string(const std::string& str) {
   static std::string cuda_prefix("torch.cuda.");
+  static std::string xpu_prefix("torch.xpu.");
   static c10::once_flag cpu_once;
   static c10::once_flag cuda_once;
+  static c10::once_flag xpu_once;
   static std::unordered_map<std::string, at::DeprecatedTypeProperties*> cpu_map;
+  static std::unordered_map<std::string, at::DeprecatedTypeProperties*> xpu_map;
   static std::unordered_map<std::string, at::DeprecatedTypeProperties*>
       cuda_map;
 
@@ -95,6 +98,16 @@ at::TensorOptions options_from_string(const std::string& str) {
       }
     });
     map = &cuda_map;
+  } else if (
+      std::mismatch(xpu_prefix.begin(), xpu_prefix.end(), str.begin()).first ==
+      xpu_prefix.end()) {
+    // torch.xpu. is prefix of str
+    c10::call_once(xpu_once, []() {
+      for (auto type : autograd::VariableType::allXPUTypes()) {
+        xpu_map.emplace(type_to_string(*type), type);
+      }
+    });
+    map = &xpu_map;
   } else {
     c10::call_once(cpu_once, []() {
       for (auto type : autograd::VariableType::allCPUTypes()) {
-- 
2.34.1

